---
title: 分享一种通用的数仓分层规范
permalink: datawarehouse-data-stratified
date: 2021-06-28 00:56:45
updated: 2021-06-28 00:56:46
tags: 
    - 数仓
categories: data
toc: true
thumbnail: https://static.studytime.xin/article/20210313130325.png
excerpt: 数据分层是数仓模型设计中十分重要的环节，优秀的分层设计能够让整个数据体系更易理解和使用。
---


### 前言

从事数仓相关工作的人员都知道数仓模型设计的，首要工作之一就是进行模型分层，可见模型分层在模型实际过程中的重要性。确实，优秀的分层设计是一个数仓项目能否建设成功的核心要素， 好的模型分层对数据资产化起着决定作用，可以让数据高复用，易理解和使用等。

而目前网络中大部分可以被检索到相关文章只是简单地提及数据分层的设计，或者给出自己公司的方案，而未讲述具体原因，甚至有的分三层，有的分四层，也有分五层，各种各样。
缺乏明确而详细的说明，以及落地实施的方案为什么这样等等。

因此，本文将对数据仓库分层方法进行全方位的阐述和整理，具体包含如下内容：

1、介绍为什么分层，分层的作用，核心思想
2、提出一种通用的数据分层设计，以及分层设计的原则
3、特殊分层策略说明，包括三层、四层、五层等案例及原因
4、讲述可落地的实践意见




数据分层是数仓模型设计中十分重要的环节，优秀的分层设计能够让整个数据体系更易理解和使用,本文结合现有公司分层架构进行讲述，同时也分享一些新的想法和扩展。

![](https://static.studytime.xin/article/20210312000046.png)

### 数仓分层意义，也可以说是为什么分层？


数仓分层目的是使用空间换时间，通过大量预处理，提升用户数据加工效率等，故而存在大量数据冗余。 通过数据分层管理可以将复杂的逻辑拆解成多步骤进行，一步的工作分到了多个步骤去完成，每一层的处理逻辑都相对简单和容易理解，这样我们的逻辑就会更加简单清晰，而不会出现那种一大坨的sql，几百几千行，对于数据发生错误的时候，根据血缘定位问题也较为简单，逻辑也较为清晰。。

综上所述数据分层将可以给我们带来如下的好处：
1、清晰数据结构：每一个数据分层都有它的作用域和职责，在使用表的时候能更方便地定位和理解
2、减少重复开发：规范数据分层，开发一些通用的中间层数据，能够减少极大的重复计算
3、统一数据口径：通过数据分层，提供统一的数据出口，统一对外输出的数据口径
4、复杂问题简单化：将一个复杂的任务分解成多个步骤来完成，每一层解决特定的问题


分层的核心思想？
分层的核心思想就是解耦，把复杂的问题简单化，这直接影响了数据架构到底分几层。

![](https://static.studytime.xin//studytime/image/articles/fs8Q8P.png)

### 数仓到底应该分几层？



### 通用可行的数仓分层设计方案
为了满足前面提到数据分层带来的好处，建议将数据模型分为三层：基础数据层（ ODS、STG ）、公共维度模型层（CDM或EDW）和数据应用层（ADS）。如下图所示。简单来讲，我们可以理解为：

- 基础数据层存放的是接入的原始数据
- DW层是存放我们要重点设计的数据仓库中间层数据
- 数据应用层是面向业务定制的应用数据。

### 基础数据层
包含 STG（数据缓冲层）与 ODS（原始数据层）两层，这两层数据结构与业务数据几乎一致。

#### STG （数据准备区或数据缓冲区）
定位是缓存来自 DB 抽取、消息、日志解析落地的临时数据，结构与业务系统保持一致；负责对垃圾数据、不规范数据进行清洗转换；该层除为ODS 层服务外，不提供服务，也就是不能被其他更上层次调用。

#### ODS （原始数据层或操作数据层）
操作数据层定位于业务明细数据保留区，负责保留数据接入时点后历史变更数据，数据原则上全量保留。可以在此层对增量数据或者拉链表数据进行合并。

### 公共维度模型层CDM（Common Data Model）或者 企业级数据仓库EDW （Enterprise Data Warehouse）
公共维度模型层主要用于存放明细事实数据、维表数据及公共指标汇总数据，其中明细事实数据、维表数据一般根据ODS层数据加工生成；公共指标汇总数据一般根据维表数据和明细事实数据加工生成。本层采用维度模型作为建模方法的理论基础，更多的是通过采用一些维度退化手段，将维度退化至事实表中，减少维表和事实表的关联，提高数据易用性。

#### 明细数据层：DWD（Data Warehouse Detail）
该层一般保持和ODS层一样的数据粒度，并且提供一定的数据质量保证。同时，为了提高数据明细层的易用性，该层会采用一些维度退化手法，将维度退化至事实表中，减少事实表和维表的关联。同时在此层会采用明细宽表，复用关联计算，极少数据扫描。举例：订单主表以及订单明细表，可以以订单明细表作为最小粒度，连表整合订单表数据，生成dwd层订单事实表。

#### 数据汇总层：DWS（Data WareHouse Summary）
该层会在DWD层的数据基础上，对数据做轻度的聚合操作，生成一系列的中间表，提升公共指标的复用性，减少重复加工。直观来讲，就是对通用的核心维度进行聚合操作，算出相应的统计指标。

#### 公共维度层：DIM（Dimension）
该层会对维度进行统一标准化定义，实现维度信息共享，该层存储的数据主要有两种，分别为：
- 高基数维度数据：一般是用户资料表、商品资料表类似的实体表。数据量可能是千万级或者上亿级别
- 低基数维度数据：一般是配置表，比如枚举值对应的中文含义，或者日期维表。数据量可能是个位数或者几千几万

#### 公共维度模型层CDM主要作用
1、组合相关和相识数据，采用明细宽表，复用关联计算，减少数据扫描
2、公共指标统一加工，为上层数据产品应用，服务提供公共指标，建立逻辑汇总宽表
3、建立一致性维度，一致性的数据分析维度，降低数据计算口径，解决算法不同意的风险


### 应⽤层 ADS（Application Data Mart-应⽤数据集市）
数据应用层，也叫DM(数据集市)或APP层等，面试实际的数据需求，可以直接给业务人员使用，以DWD或者DWS层的数据为基础，组成各种统计报表。除此之外还有一些直接的表现形式，例如主题大宽度表集市，以及横表转纵表等。

### 什么是宽表？
宽表这块我的理解是，基于维度模型的扩展，采用退化维度的方式，将不同维度的度量放入数据表的不同列中，同时将于主分析维度相关的指标进行整合，更利于理解，以及较好的查询性能。
宽表物理设计结构分别有：
1、基本属性
2、日行为汇总指标
3、周期行为汇总指标
4、历史累计属性和指标

### 分层架构及加工流程
![WuGm2s](https://static.studytime.xin//studytime/image/articles/WuGm2s.jpg)

### 思考和总结一下
从数据应用理解上来讲，目的是希望越上层次，对使用者约友好。比如ADS层，基本是完全为应用来设计的，很易懂，DWS层的话，相对来讲就会有一点点理解成本，然后DWD层就比较难理解了，因为它的维度可能会比较多，而且一个需求可能要多张表经过很复杂的计算才能完成。
从能力范围来讲，我们希望80%需求由20%的表来支持。直接点讲，就是大部分（80%以上）的需求，都用DWS的表来支持就行，DWS支持不了的，就用DWD的表来支持，这些都支持不了的极少一部分数据需要从原始日志中后去。

### 一些不同的分层思路
这里将一些扩展，本文此处讲解的分层方法是作者公司现有的分层架构，在实际的操作中也有一些大公司有一些其他分层方法，下面进行一些举例：
1、对于基础数据层，很多公司综合考虑存储成本及分析成本，会去除STG（数据缓冲层），其职责会被ODS和DWD各自获取
2、对于公共维度模型层CDM，很多公司会在数据汇总层DWS上层增加一层，可以叫做DWT数据主题层，主要用于存放一些不跨主题的宽表，整合单主题下的指标，进行单主题宽表化
3、也有很对公司会在应⽤层中，ADS层前整合一层DW层，称为数据集市层，用于存放跨主题，用于解决复杂分析的，多维度冗余数据，也就是跨主题宽表化。